# Easy Pest Control API

## Before starting the application:

 - Make sure to have:
    - config/
        - development.env
        - production.env
    
    - That musts consists of following keys:
        - PORT
        - DB_NAME
        - DB_USER
        - DB_HOST
        - DB_PASSWORD
            
    - `postgres` should be installed with `user` with strict `password`. Once available, set the corresponding values in the *.env files. 

## Starting up the application:

 - `npm install` : Will install all the dependencies

 - `npm run dev` : Will start application in development environment

 - `npm run prod` : Will start application in production environment

 ## Setting up database
 - Use `intial_data.dump` which has the init data to seed the server database using 
 `pg_restore -U nishanth -d init_db_test -h localhost -Fc intial_data.dump`

 - This dump file is generated by executing
 `pg_dump -U nishanth -d init_db -h localhost -Fc -f intial_data.dump`

 ## Setting up server

 - `sudo apt update`
 - `sudo apt upgrade -y`
 - `sudo apt install git -y`
 - `sudo apt install unzip -y`
 - `sudo apt install nginx -y`
 - `sudo systemctl start nginx`
 - `sudo systemctl enable nginx`
 - `sudo systemctl status nginx`
 - `sudo ufw allow 'Nginx Full'`
 - `sudo apt install certbot python3-certbot-nginx -y`
 - `sudo apt install postgresql postgresql-contrib -y`
 - `curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash`
 - `export NVM_DIR="$([ -z "${XDG_CONFIG_HOME-}" ] && printf %s "${HOME}/.nvm" || printf %s "${XDG_CONFIG_HOME}/nvm")"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"`
 - `nvm install 20`
 - `npm install -g pm2`
 - `npm install -g @prisma/cli`

 - `ssh-keygen` : Create ssh key in server and add it to github SSH keys
    - Under the path `/home/ubuntu/.ssh/nishanth_github`
    - Add the following config in the ssh config file
    - `Host github.com
            User nishanth-shanmuganathan
            IdentityFile ~/.ssh/nishanth_github`

 - In `~` path of the server execute `git clone git@github.com:Nishanth-Shanmuganathan/easy-pest-control-api.git`
 - `cd easy-pest-control-api`
 - `npm i`
 - `mkdir config && touch config/production.env .env`
 - Copy the secret credentials from the secured .env files to the created files

 - Create nginx configuration for api in `/etc/nginx/sites-available/api.enttec.ind.in`
 - `server {
  server_name api.enttec.ind.in;
  location / {
    proxy_pass http://localhost:4000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
  }
 }`
 - `sudo ln -s /etc/nginx/sites-available/api.enttec.ind.in /etc/nginx/sites-enabled/`
 - `sudo nginx -t`

 - `sudo certbot`

 - `sudo -i -u postgres`
    - `psql`
        - `CREATE DATABASE epc_production;`
        - `CREATE USER nishanth WITH PASSWORD '<PASSWORD>' SUPERUSER;`
        - `\q`
    - `exit`
 - `psql -U nishanth -d epc_production -h localhost` - Verify access
 - `npx prisma migrate deploy`
 - `npx prisma generate`

 # Set auto-increment start value
 - `ALTER SEQUENCE "Booking_id_seq" RESTART WITH 260;`
 - `ALTER SEQUENCE "Booking_uid_seq" RESTART WITH 260;`
